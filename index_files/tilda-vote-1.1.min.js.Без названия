function tvote__init(e){if(void 0===$(".t-records").attr("data-tilda-mode")){var t=new Date;mouseMoved=!1,$(document).on("touchstart mousemove",function(e){mouseMoved=!0});var o=$("#rec"+e).find(".t-vote"),n=tvote__makeFullVoteID(o),i={type:o.attr("data-vote-type"),voteID:n,voteEl:o,voteVisibility:o.attr("data-vote-visibility"),startDate:t};tvote__checkVoteCondition(i),"yes"!=o.attr("data-vote-finished")?setTimeout(function(){tvote__initOneVote(i)},500):o.addClass("t-vote_sended")}}function tvote__makeFullVoteID(e){var t=e.attr("data-vote-id");if(void 0!==t){var o=$(".t-records").attr("data-tilda-project-id")+t;return o=o.replace("&quot;","").replace("&#039;","").replace(/[&\/\\#,+()$~%.'":;*?!<>{}\-_\s]/g,""),e.attr("data-vote-id",o),o}}function tvote__initOneVote(e){e.voteEl.find(".js-sendvote-btn").on("click",function(t){if(!e.voteEl.hasClass("js-vote-sending")){var o=!0;"single"==e.type&&(e.answerID=$(this).parents(".js-vote-item").attr("data-answer-id"),e.clickedEl=$(this),e.url="https://vote.tildacdn.com/vote/1/",o=tvote__handleClick__single(e)),"multi"==e.type&&(e.url="https://vote.tildacdn.com/vote/2/",o=tvote__handleClick_multi(e)),o&&(tvote__itemSend(e),t.preventDefault())}})}function tvote__handleClick__single(e){return!(!e.clickedEl.hasClass("t-vote__btn-el_active")&&e.voteEl.hasClass("js-vote-sended"))&&(!e.clickedEl.hasClass("t-vote__btn-el_active")||!e.voteEl.hasClass("js-vote-sended")||(void 0!==tvote__getCookie("vote_candelete"+e.voteID)&&tvote__itemDelete_single(e),!1))}function tvote__handleClick_multi(e){var t=[],o=e.voteEl.find(".js-vote-question:has(.js-vote-btn:checked)"),n=e.voteEl.find(".js-vote-question").length;return!e.voteEl.hasClass("js-vote-sended")&&(o.length!=n?("RU"==window.tildaBrowserLang?tvote__showError(e.voteID,"Пожалуйста, ответьте на все вопросы."):tvote__showError(e.voteID,"Please, answer all questions."),!1):(o.each(function(){var o=$(this).attr("data-question-id"),n=[];$(this).find(".js-vote-btn:checked").each(function(){var t=$(this).parents(".js-vote-item").attr("data-answer-id");n.push(t+"-"+o+"-"+e.voteID)}),t.push({answer:n,question:o})}),e.answerArr=t,!0))}function tvote__itemSend(e){e.seconds_fromStart=((new Date).getTime()-e.startDate.getTime())/1e3,tvote__changeVoteCondition(e,"add"),e.voteEl.addClass("js-vote-sending t-multivote_sended"),tvote__addLoadingStyle(e.voteEl,e.voteID),"onclick"==e.voteVisibility&&e.voteEl.find(".t-vote__btn-res").css("display","block"),$.ajax({type:"POST",url:e.url+"init/",crossDomain:!0,xhrFields:{withCredentials:!0},data:{host:location.protocol+"//"+location.host},dataType:"text",async:!1,success:function(t){var o=$.parseJSON(t);"object"!=typeof o&&tvote__showError(e.voteID,""),e.sessionKey=o.key,e.sessionCookie=o.session,e.voteHash=e.voteID+e.sessionKey,tvote__itemSend_continue(e)},error:function(t){console.log("Fatal error:"),console.log(t),tvote__changeVoteCondition(e,"remove"),tvote__showError(e.voteID,"")},timeout:15e3})}function tvote__itemSend_continue(e,t){var o=$(".t-records").attr("data-tilda-page-id"),n=$(".t-records").attr("data-tilda-project-id"),i={hash:e.voteHash,projectid:n,pageid:o,host:location.protocol+"//"+location.host,time:e.seconds_fromStart,session:e.sessionCookie};"single"==e.type&&(i.voteid=e.voteID,i.answerid=e.answerID),"multi"==e.type&&(i.multivoteid=e.voteID,i.answers=e.answerArr),void 0!==t&&(i.votecaptcha=t,tvote__changeVoteCondition(e,"add")),$.ajax({type:"POST",url:e.url+"send/",crossDomain:!0,xhrFields:{withCredentials:!0},data:i,dataType:"text",success:function(t){e.voteEl.removeClass("js-vote-sending t-vote_loading");var o=$.parseJSON(t);"object"!=typeof o&&tvote__showError(e.voteID,""),void 0===o.error?(e.voteEl.addClass("js-vote-sended t-vote_sended"),tvote__writeSendCookie(o,e),e.voteEl.find(".t-vote__errorbox").remove(),$(".t-vote").trigger("tildavote:resultsended")):(tvote__changeVoteCondition(e,"remove"),e.voteEl.removeClass("t-vote_sended"),tvote__handleServerError(o,e))},error:function(t){console.log("Fatal error:"),console.log(t),tvote__showError(e.voteID,"")},timeout:15e3})}function tvote__writeSendCookie(e,t){"ok"==e.message&&(tvote__setCookie("vote"+e.voteid,t.voteHash,{expires:86400}),"single"==t.type&&(tvote__setCookie("voteresult"+e.voteid,t.answerID,{expires:86400}),tvote__setCookie("vote_candelete"+e.voteid,"yes",{expires:1800})))}function tvote__itemDelete_single(e){(new Date).getTime(),e.startDate.getTime();tvote__changeVoteCondition(e,"remove"),e.voteEl.addClass("js-vote-sending").removeClass("t-vote_sended"),tvote__addLoadingStyle(e.voteEl,e.voteID),e.voteHash=tvote__getCookie("vote"+e.voteID),$.ajax({type:"POST",url:"https://vote.tildacdn.com/vote/1/delete/",crossDomain:!0,data:{voteid:e.voteID,hash:e.voteHash,host:location.protocol+"//"+location.host},dataType:"text",success:function(t){e.voteEl.removeClass("js-vote-sending t-vote_loading");var o=$.parseJSON(t);"object"!=typeof o&&tvote__showError(voteID,""),void 0===o.error?(e.voteEl.removeClass("js-vote-sended t-vote_sended"),tvote__removeSendCookie(o,e)):(tvote__changeVoteCondition(e,"add"),e.voteEl.addClass("t-vote_sended"),tvote__handleServerError(o,e))},error:function(t){console.log("Fatal error:"),console.log(t),tvote__showError(e.voteID,"")},timeout:15e3})}function tvote__removeSendCookie(e,t){"ok"==e.message&&(tvote__setCookie("vote"+e.voteid,t.voteHash,{expires:1}),tvote__setCookie("voteresult"+e.voteid,"",{expires:1}),tvote__setCookie("vote_candelete"+e.voteid,"",{expires:1}))}function tvote__addLoadingStyle(e,t){setTimeout(function(){e.hasClass("js-vote-sending")&&e.addClass("t-vote_loading")},150)}function tvote__checkVoteCondition(e){var t=tvote__getCookie("vote"+e.voteID),o=tvote__getCookie("voteresult"+e.voteID);("yes"==e.voteVisibility||"onclick"==e.voteVisibility&&void 0!==t)&&e.voteEl.find(".t-vote__btn-res").css("display","block"),void 0!==t&&e.voteEl.addClass("js-vote-sended t-vote_sended"),"single"==e.type&&void 0!==t&&void 0!==o&&e.voteEl.find("[data-answer-id="+o+"] .t-vote__btn-el").addClass("t-vote__btn-el_active"),tvote__getResult(e.voteID)}function tvote__handleServerError(e,t){if(6==e.error)return window.tvote_opts=t,void addTildaCaptcha();var o="";o="RU"==window.tildaBrowserLang?"Что-то пошло не так и голосование не может корректно работать. Пожалуйста, попробуйте другой браузер, отключите режим инкогнито или обратитесь к владельцу сайта.":"Something went wrong and vote doesn't work correctly. Please, try another browser, unlock private mode or write to website owner.",1==e.error&&(o="RU"==window.tildaBrowserLang?"С этого IP недавно голосовали. Пожалуйста, подождите 10 минут и попробуйте еще раз.":"Somebody has recently voted from this IP. Please, wait 10 minutes and try again."),2==e.error&&(o="RU"==window.tildaBrowserLang?"С вашего IP адреса приходит слишком много запросов к серверу. Сервер временно не может принимать голоса с этого IP. Пожалуйста, попробуйте еще раз позже.":"There are too many votes from your IP. Server temporarily can't get votes from this IP. Please, try again later."),4==e.error&&(o="RU"==window.tildaBrowserLang?"Извините, но голос удалить уже нельзя. Удалить голос можно только в течение 30 минут после активации.":"Sorry, but you can't delete vote now. You can delete votes just during 30 minutes after activation."),5==e.error&&(o="RU"==window.tildaBrowserLang?"С вашего IP запросы приходят слишком часто. Пожалуйста, подождите 7 секунд прежде чем выбирать ответы в слудующих голосованиях на странице.":"Votes are sended too often from your IP. Please, wait 7 seconds between choosing answers in different votes."),tvote__showError(t.voteID,o)}function addTildaCaptcha(){$("#tildavotecaptchabox").remove(),$("body").append('<div id="tildavotecaptchabox" style="z-index: 100000;position:fixed; text-align: center; vertical-align: middle; top: 0px; left:0px; bottom: 0px; right: 0px; background: rgba(255,255,255,0.97);"><iframe id="captchaIframeBox" src="https://vote.tildacdn.com/vote/1/send/showcaptcha.php" frameborder="0" width="100%" height="100%"></iframe></div>'),window.removeEventListener("message",checkVerifyTildaVoteCaptcha),window.addEventListener("message",checkVerifyTildaVoteCaptcha)}function checkVerifyTildaVoteCaptcha(){if(-1!=event.origin.indexOf("vote.tildacdn.com")){if("closeiframe"==event.data)return void $("#tildaformcaptchabox").remove();$("#tildavotecaptchabox").remove(),tvote__itemSend_continue(window.tvote_opts,event.data)}}function tvote__showError(e,t){""==t&&(t="RU"==window.tildaBrowserLang?"Что-то пошло не так и голосование может работать некорректно. Пожалуйста, проверьте соединение с интернетом или обратитесь к владельцу сайта.":"Something went wrong and vote doesn't work correctly. Please, check your internet connection or write to website owner.");var o=$("[data-vote-id="+e+"]"),n=o.attr("data-vote-type");if("single"==n||void 0===n){var i="<div class='t-vote__errorbox'><div class='t-vote__errorbox-text t-text t-text_xs t-align_center' style='background-color:#333;color:#fff;padding:20px;margin-top:30px;'>"+t+"</div></div>";o.after(i),o.css("display","none")}if("multi"==n){o.find(".t-vote__errorbox").remove();i="<div class='t-vote__errorbox'><div class='t-vote__errorbox-text t-text t-text_xs t-align_center' style='background-color:#F95D51;color:#fff;padding:20px;margin:30px 0px;'>"+t+"</div></div>";o.find(".js-sendvote-btn").last().before(i)}}function tvote__getResult(e){var t=$("[data-vote-id="+e+"]"),o=t.attr("data-vote-type");if("single"==o)var n="https://vote.tildacdn.com/vote/1/getresult/";if("multi"==o)n="https://vote.tildacdn.com/vote/2/getresult/";void 0!==o&&$.ajax({type:"GET",url:n,crossDomain:!0,data:{voteid:e,host:location.protocol+"//"+location.host},async:!1,dataType:"text",success:function(n){var i=$.parseJSON(n);"object"!=typeof i&&tvote__showError(e,""),void 0===i.error?("single"==o&&Object.keys(i[0]).forEach(function(e,o){t.find("[data-answer-id="+e+"] .js-vote-count").html(i[0][e])}),"multi"==o&&($.each(i[0],function(e,o){var n=0;$.each(o,function(e,t){n+=1*t}),$.each(o,function(o,i){var a=Math.round(100*i/n),r=o.slice(0,o.indexOf("-")),s=t.find("[data-question-id="+e+"] [data-answer-id="+r+"]");s.find(".js-vote-count").html(i),s.find(".js-vote-percent").html(a+"%")})}),setTimeout(function(){$(".t-vote").trigger("tildavote:numberschanged")},1e3))):t.find(".t-vote__btn-res").css("display","none")},error:function(t){console.log("Fatal error:"),console.log(t),tvote__showError(e,"")},timeout:5e3})}function tvote__changeVoteCondition(e,t){"multi"==e.type&&tvote__changeStat(e,t),"single"==e.type&&"add"==t&&(tvote__incrementAnswerNum(e.voteID,e.answerID),e.voteEl.find("[data-answer-id="+e.answerID+"] .t-vote__btn-el").addClass("t-vote__btn-el_active")),"single"==e.type&&"remove"==t&&(tvote__decrementAnswerNum(e.voteID,e.answerID),e.voteEl.find(".t-vote__btn-el_active").removeClass("t-vote__btn-el_active"))}function tvote__changeStat(e,t){e.voteEl.find(".js-vote-question").each(function(){var e=$(this).find(".js-vote-item"),o=0;e.each(function(){var e=$(this).find(".js-vote-count");if(void 0!==e){var n=1*e.html();o+=n;var i=$(this).find(".js-vote-btn:checked").length;0!=i&&"add"==t&&(o++,n++,e.html(n)),0!=i&&"remove"==t&&(o--,n--,e.html(n))}}),e.each(function(){var e=$(this).find(".js-vote-count"),t=$(this).find(".js-vote-percent"),n=1*e.html(),i=Math.round(100*n/o);0!=o?(e.html(n),void 0!==t&&t.html(i+"%")):(e.html("0"),void 0!==t&&t.html("0%"))})}),$(".t-vote").trigger("tildavote:numberschanged")}function tvote__incrementAnswerNum(e,t){var o=$("[data-vote-id="+e+"] [data-answer-id="+t+"] .js-vote-count"),n=o.html();o.html(1*++n)}function tvote__decrementAnswerNum(e,t){var o=$("[data-vote-id="+e+"] [data-answer-id="+t+"] .js-vote-count"),n=o.html();o.html(1*--n)}function tvote__getCookie(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):void 0}function tvote__setCookie(e,t,o){var n=(o=o||{}).expires;if("number"==typeof n&&n){var i=new Date;i.setTime(i.getTime()+1e3*n),n=o.expires=i}n&&n.toUTCString&&(o.expires=n.toUTCString());var a=e+"="+(t=encodeURIComponent(t));for(var r in o){a+="; "+r;var s=o[r];!0!==s&&(a+="="+s)}document.cookie=a}
